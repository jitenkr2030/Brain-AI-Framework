apiVersion: v1
kind: ConfigMap
metadata:
  name: lms-grafana-dashboard
  namespace: monitoring
data:
  lms-overview.json: |
    {
      "dashboard": {
        "title": "LMS Platform Overview",
        "uid": "lms-overview",
        "timezone": "browser",
        "refresh": "30s",
        "panels": [
          {
            "title": "Request Rate",
            "type": "graph",
            "gridPos": {"x": 0, "y": 0, "w": 12, "h": 8},
            "targets": [
              {
                "expr": "rate(http_requests_total[5m])",
                "legendFormat": "{{method}} - {{status}}"
              }
            ]
          },
          {
            "title": "Response Time (95th percentile)",
            "type": "graph",
            "gridPos": {"x": 12, "y": 0, "w": 12, "h": 8},
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
                "legendFormat": "{{handler}}"
              }
            ]
          },
          {
            "title": "Error Rate",
            "type": "graph",
            "gridPos": {"x": 0, "y": 8, "w": 12, "h": 8},
            "targets": [
              {
                "expr": "rate(http_requests_total{status=~\"5..\"}[5m]) / rate(http_requests_total[5m])",
                "legendFormat": "Error Rate"
              }
            ]
          },
          {
            "title": "Active Users",
            "type": "stat",
            "gridPos": {"x": 12, "y": 8, "w": 6, "h": 4},
            "targets": [
              {
                "expr": "sum(active_users)",
                "legendFormat": "Active Users"
              }
            ]
          },
          {
            "title": "Course Enrollments",
            "type": "stat",
            "gridPos": {"x": 18, "y": 8, "w": 6, "h": 4},
            "targets": [
              {
                "expr": "sum(course_enrollments_total)",
                "legendFormat": "Total Enrollments"
              }
            ]
          },
          {
            "title": "Database Connections",
            "type": "graph",
            "gridPos": {"x": 0, "y": 16, "w": 12, "h": 8},
            "targets": [
              {
                "expr": "pg_stat_activity_count",
                "legendFormat": "Active Connections"
              }
            ]
          },
          {
            "title": "Cache Hit Rate",
            "type": "graph",
            "gridPos": {"x": 12, "y": 16, "w": 12, "h": 8},
            "targets": [
              {
                "expr": "redis_keyspace_hits / (redis_keyspace_hits + redis_keyspace_misses)",
                "legendFormat": "Cache Hit Rate"
              }
            ]
          }
        ]
      }
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: lms-grafana-datasources
  namespace: monitoring
data:
  datasources.yml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus:9090
        isDefault: true
        editable: false
      - name: Loki
        type: loki
        access: proxy
        url: http://loki:3100
        editable: false
